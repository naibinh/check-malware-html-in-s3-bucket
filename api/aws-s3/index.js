const AWS = require('aws-sdk');
AWS.config.loadFromPath(__dirname + '/../../config/s3/credential.json');

const bucket = require('../../config/s3/bucket');
const s3 = new AWS.S3();

const getHtmlUrls = () => {
    return new Promise((resolve, reject) => {
        let result = [];
        // listObjects only list up to 1000 objects
        s3.listObjects(bucket.params).on('success', function handlePaging(response) {
            if (response.error) {
                reject(response.error);
            } else {
                const htmlUrls = response.data.Contents
                    .filter(content => content.Key.endsWith('.html'))
                    .map(content => ({
                        url: `${bucket.endpoint}/${bucket.params.Bucket}/${content.Key}`
                    }));
                result = result.concat(htmlUrls);
                if (response.hasNextPage()) {
                    // get next if having more
                    response.nextPage().on('success', handlePaging).send();
                } else {
                    resolve(result);
                }
            }

        }).send();
    });
};

module.exports = getHtmlUrls;